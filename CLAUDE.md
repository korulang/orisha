- NEVER SUGGEST NOT FIXING THINGS PROPERLY, THE TOOLCHAIN IS THE ONLY THING OF VALUE.

## ðŸ§¬ Project Consciousness
Optimizing and benchmarking Orisha's performance against industry-standard frameworks while refining the router DSL and server lifecycle semantics.

### Decisions
- **Refactor `orisha:router` to use inline body codegen with Zig block expressions (`blk: { ... }`).**: Improves performance by reducing event-dispatch overhead and allows the router to directly access runtime values from the call-site scope.
- **Prioritize compile-time pre-compression over runtime compression for static assets.**: Benchmarks showed runtime compression costs ~45% performance. Pre-compression allows Orisha to outperform Nginx (gzip_static) by 27%.
- **Adopt TechEmpower-style optimizations (snmalloc, SIMD-json, zero-copy) for Orisha benchmarks.**: To establish a high-performance baseline against industry leaders like Actix-web and .NET Kestrel under high concurrency.
- **Replace 'listening' branch with 'shutdown' and 'failed' semantics in the server 'serve' event.**: The 'listening' branch was misleading as the server enters an infinite accept loop; 'shutdown' provides honest semantics for the server lifecycle.
- **Rename the router's input parameter from `expr` to `req`.**: Improves API clarity and domain alignment with HTTP requests.
- **Implement string-based deduplication in `compiler_requires.zig`.**: Prevents 'file exists in modules' and 'redefinition' errors when multiple Koru files require the same dependency.
- **Update `runtime.kz` dispatcher to return `error.EventDenied` for missing events.**: Aligns runtime behavior with test suite expectations for sandboxed execution security.
- **Treat multi-part blocks (try/catch/finally, switch/case) as atomic units for [norun|expand] annotations.**: Simplifies the parser and prevents ambiguous states where a 'try' runs but its 'catch' is marked 'norun'.
- **Established /usr/local/lib/koru as the global system path for Koru compiler sources and standard library.**: Allows the compiler to behave as a standard system tool and fixes fragility of 'koruc run' outside the repo root.
- **Remove `const` and `var` from `std.types` and focus it strictly on type declarations (struct, enum, union).**: Value declarations are handled by raw Zig or `~const` in `control.kz`. Keeping `types.kz` focused on structural definitions is semantically cleaner.
- **Standardize on Liquid-style `{{ var }}` and `{% if %}` syntax across the entire language, deprecating `${var}`.**: To avoid developer confusion and provide a unified, powerful metaprogramming interface.
- **Orthogonal Type System Architecture (Shape vs. Phantom)**: Separates structural validation (field names/types) from semantic lifecycle tracking (phantom states).

### Instructions & Usage
### ðŸ§  Semantic Memory & Search
This project uses `prose` to maintain a cross-session semantic memory of decisions, insights, and story beats.

- **Semantic Search**: If you're unsure about a past decision or need context on a feature, run:
  ```bash
  prose search "your question or keywords"
  ```
- **Project Status**: To see a summary of recent sessions and evolved memory, run:
  ```bash
  prose status
  ```
- **View Chronicles**: Run `prose serve` to browse the interactive development timeline in your browser.


### Active Gotchas
- **Misleading server lifecycle events (e.g., a 'listening' branch that is never reached due to the infinite accept loop).**: Refactor event branches to 'shutdown' and 'failed' to reflect honest execution semantics.
- **Runtime compression (Gzip) significantly degrades performance (up to 45% in some frameworks).**: Prioritize compile-time pre-compression or static file serving with pre-compressed assets (gzip_static) to maintain high throughput.
- **Duplicate module definitions in generated Zig code when multiple Koru files require the same dependency.**: Implement string-based deduplication in the CompilerRequiresCollector using a StringHashMap.
- **Zig keyword escaping collisions (e.g., @\"@\"error\"\") in the backend emitter.**: Refine escaping logic in the Zig emitter and update runtime.kz error names to avoid reserved keywords.
- **The router transformation previously generated separate events, causing scope issues for local variables.**: Use inline body codegen (Zig 'blk: {}' expressions) so runtime values from the call-site scope are directly accessible.


> [!NOTE]
> This file is automatically generated from `CLAUDE.md.template` by `prose`.
> Last updated: 2/7/2026, 7:25:47 PM
