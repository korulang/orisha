# nginx configuration for static benchmark
# Run: nginx -c $(pwd)/nginx.conf
# Serves on port 3001

worker_processes auto;
daemon off;
error_log /dev/null;
pid /tmp/nginx-benchmark.pid;

events {
    worker_connections 1024;
    use kqueue;
}

http {
    access_log off;

    # MIME types
    include /opt/homebrew/etc/nginx/mime.types;
    default_type application/octet-stream;

    # Gzip - use pre-compressed if available
    gzip_static on;
    gzip on;
    gzip_types text/html text/css application/javascript application/json;
    gzip_min_length 100;

    # TCP optimizations
    tcp_nodelay on;
    tcp_nopush on;

    # File serving optimizations
    sendfile on;

    # File descriptor cache
    open_file_cache max=1000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    server {
        listen 3001;

        location / {
            root BENCHMARK_ROOT/shared/public;
            index index.html;
        }

        location /about {
            alias BENCHMARK_ROOT/shared/public/about.html;
        }

        location /api/health {
            return 200 '{"status":"ok"}';
            add_header Content-Type application/json;
        }

        # Dynamic endpoint placeholder (nginx can't really do this efficiently)
        location ~ ^/api/users/(\d+)$ {
            return 200 '{"id":"$1","name":"User $1"}';
            add_header Content-Type application/json;
        }
    }
}
